\chapter{Phân tích và thiết kế hệ thống}

\section{Kiến trúc tổng thể}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.6cm]
    \node (client) [block, text width=12em] {Client (Browser)\\Web Crypto AES‑GCM\\MetaMask};
    \node (api) [block, right=5.0cm of client, text width=13em] {Backend (Next.js)\\JWT session, CSRF\\SQLite metadata};
    \node (store) [block, below=2.0cm of api, text width=13em] {Storage (Local/Stub IPFS)\\Ciphertext by CID};
    % Two arcs between the same nodes to avoid label overlapping
    \draw[arrow] (client.east) to[out=5,in=175,looseness=0.95] node[above,pos=0.55,yshift=6]{Đăng nhập: ký nonce} (api.west);
    \draw[arrow] (client.east) to[out=-10,in=185,looseness=1.15] node[below,pos=0.55,yshift=-6]{Upload ciphertext} (api.west);
    % Vertical API <-> Storage
    \draw[arrow] (api.south) -- node[right,xshift=6]{PUT/GET by CID} (store.north);
    % Client -> Storage with a bend
    \draw[arrow] (client.south east) to[out=-30,in=180] node[below,pos=0.6,yshift=-6]{Tải xuống + giải mã} (store.west);
  \end{tikzpicture}
  \caption{Kiến trúc hệ thống và luồng chính}
\end{figure}

\section{Thiết kế bảo mật}
\begin{itemize}
  \item \textbf{Zero‑knowledge server}: máy chủ không giữ khoá giải mã.
  \item \textbf{AEAD}: AES‑GCM bảo vệ bí mật và toàn vẹn dữ liệu.
  \item \textbf{IV 96‑bit ngẫu nhiên}: sinh mới mỗi lần mã hoá.
  \item \textbf{Token TTL + thu hồi}: giảm cửa sổ tấn công.
  \item \textbf{CSRF + SameSite Cookie}: bảo vệ yêu cầu thay đổi trạng thái.
  \item \textbf{Đăng nhập bằng chữ ký}: loại bỏ mật khẩu phía server.
\end{itemize}

\section{Sơ đồ luồng Upload}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.1cm]
    \node (s0) [smallblock, text width=16em] {Chọn tệp, nhập tiêu đề và (tuỳ chọn) passphrase};
    \node (s1) [smallblock, below=of s0] {Sinh IV 12B, sinh khoá AES‑GCM 256‑bit};
    \node (s2) [smallblock, below=of s1] {Mã hoá bản rõ → ciphertext};
    \node (s3) [smallblock, below=of s2, text width=16em] {Nếu có passphrase: PBKDF2(200k) → wrap khoá bằng AES‑GCM};
    \node (s4) [smallblock, below=of s3] {Upload ciphertext → nhận CID};
    \node (s5) [smallblock, below=of s4, text width=16em] {Ghi metadata (IV, CID, mô tả, và wrappedKey hoặc rawKeyBase64)};
    \node (s6) [smallblock, below=of s5] {Phát hành token (UUID, TTL)};
    \foreach \i/\j in {s0/s1,s1/s2,s2/s3,s3/s4,s4/s5,s5/s6} {\draw[arrow] (\i) -- (\j);}
  \end{tikzpicture}
  \caption{Luồng tải lên và phát hành token}
\end{figure}

\section{Sơ đồ luồng Download}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.1cm]
    \node (d0) [smallblock, text width=16em] {Nhập token → server kiểm tra hạn, thu hồi, đối chiếu file};
    \node (d1) [smallblock, below=of d0, text width=16em] {Nhận metadata: IV, CID, wrappedKey hoặc rawKeyBase64};
    \node (d2) [smallblock, below=of d1] {Tải ciphertext theo CID};
    \node (d3) [smallblock, below=of d2, text width=16em] {Nếu wrapped: KDF từ passphrase, giải bao bọc khoá};
    \node (d4) [smallblock, below=of d3] {Giải mã AES‑GCM bằng IV + khoá};
    \node (d5) [smallblock, below=of d4] {Tải file rõ về máy người dùng};
    \foreach \i/\j in {d0/d1,d1/d2,d2/d3,d3/d4,d4/d5} {\draw[arrow] (\i) -- (\j);}
  \end{tikzpicture}
  \caption{Luồng tải xuống và giải mã}
\end{figure}

\section{Sơ đồ Use Case}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.0cm]
    % System boundary
    \node (boundary) [boundary, minimum width=14cm, minimum height=8cm] {};
    % Actor
    \node[actor, left=2cm of boundary.west] (user) {};
    % Draw stick figure
    \begin{scope}[shift={(user)}]
      \draw (0,0) circle [radius=0.4];
      \draw (0,-0.4) -- (0,-1.6);
      \draw (-0.7,-0.8) -- (0.7,-0.8);
      \draw (-0.6,-2.4) -- (0,-1.6) -- (0.6,-2.4);
    \end{scope}
    \node[left=0.2cm of user] {Người dùng};
    % Use cases inside boundary
    \node (uc1) [draw, ellipse, align=center, minimum width=6.2cm, minimum height=1.2cm] at ($(boundary.center)+(0,2.4)$) {Đăng nhập bằng ví (ký nonce)};
    \node (uc2) [draw, ellipse, align=center, minimum width=6.2cm, minimum height=1.2cm] at ($(boundary.center)+(0,1.0)$) {Upload (Mã hoá + Lưu ciphertext)};
    \node (uc3) [draw, ellipse, align=center, minimum width=6.2cm, minimum height=1.2cm] at ($(boundary.center)+(-3.5,-0.4)$) {Phát hành token};
    \node (uc4) [draw, ellipse, align=center, minimum width=6.2cm, minimum height=1.2cm] at ($(boundary.center)+(3.5,-0.4)$) {Thu hồi token};
    \node (uc5) [draw, ellipse, align=center, minimum width=6.2cm, minimum height=1.2cm] at ($(boundary.center)+(0,-1.8)$) {Download \& Decrypt};
    % Associations
    \draw (user.east) -- (uc1.west);
    \draw (user.east) -- (uc2.west);
    \draw (user.east) -- (uc3.west);
    \draw (user.east) -- (uc4.west);
    \draw (user.east) -- (uc5.west);
  \end{tikzpicture}
  \caption{Sơ đồ ca sử dụng (Use Case)}
\end{figure}

\section{Sơ đồ ERD (rút gọn)}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=2.2cm]
    \node (files) [entity] {\textbf{files}\newline id (PK)\newline owner\_address\newline title, description\newline cid, name, mime\newline size\_bytes\newline iv, salt, iv\_wrap, wrapped\_key\newline raw\_key\_base64\newline created\_at};
    \node (tokens) [entity, right=4.8cm of files] {\textbf{tokens}\newline token (PK)\newline file\_id (FK→files.id)\newline issued\_to\_address\newline expires\_at\newline revoked\newline created\_at};
    \draw[arrow] (files) -- node[above]{1 : N} (tokens);
  \end{tikzpicture}
  \caption{Sơ đồ thực thể–quan hệ giữa files và tokens}
\end{figure}

\section{DFD / Threat Model tổng quát}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.4cm]
    \node (cbound) [boundary, minimum width=4.6cm, minimum height=5.0cm] {};
    \node (client) [block, text width=10.5em] at (cbound.center) {Client\\AES‑GCM, PBKDF2\\MetaMask};
    \node (api) [block, right=5.0cm of client, text width=12em] {API/Backend\\JWT/CSRF\\SQLite};
    \node (store) [block, below=of api, text width=12em] {Storage\\Ciphertext by CID};
    \draw[arrow] (client.east) to[out=5,in=175] node[above,pos=0.55,yshift=6]{Sign nonce} (api.west);
    \draw[arrow] (client.east) to[out=-10,in=185] node[below,pos=0.55,yshift=-6]{Upload ciphertext} (api.west);
    \draw[arrow] (api.south) -- node[right,xshift=6]{PUT/GET CID} (store.north);
    \draw[arrow,gray] (client.south east) to[out=-30,in=180] node[below,pos=0.6,yshift=-6]{Download + Decrypt} (store.west);
    % Threat notes
    \node[note, above=0.1cm of api] (t1) {CSRF on state-changing endpoints};
    \node[note, right=0.3cm of store] (t2) {Token leak / replay};
    \node[note, below=0.1cm of cbound] (t3) {IV reuse risk: 96-bit random IV per file};
  \end{tikzpicture}
  \caption{DFD và ghi chú đe doạ (CSRF, token leak, IV reuse)}
\end{figure}

\section{Bản đồ API}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[node distance=1.0cm]
    \node (api) [block, text width=12em] {API (Next.js)};
    \node (a1) [smallblock, above left=0.9cm and 2.6cm of api] {POST /api/auth/start};
    \node (a2) [smallblock, above right=0.9cm and 2.6cm of api] {POST /api/auth/verify};
    \node (a3) [smallblock, left=2.8cm of api] {POST /api/storage/upload};
    \node (a4) [smallblock, right=2.8cm of api] {GET /api/storage/get};
    \node (a5) [smallblock, below left=0.9cm and 2.6cm of api] {POST /api/files};
    \node (a6) [smallblock, below=1.0cm of api] {POST /api/tokens/validate};
    \node (a7) [smallblock, below right=0.9cm and 2.6cm of api] {POST /api/tokens/revoke};
    \foreach \x in {a1,a2,a3,a4,a5,a6,a7} {\draw[arrow] (api) -- (\x);}  
  \end{tikzpicture}
  \caption{Các route API chính}
\end{figure}

\section{Sequence: Đăng nhập (ký nonce)}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[x=1cm,y=1cm]
    % Participants
    \node (user) at (0,0) [part,text width=8em]{Người dùng};
    \node (client) at (6,0) [part,text width=10em]{Trình duyệt / MetaMask};
    \node (server) at (13,0) [part,text width=10.5em]{Backend (Auth API)};
    % Lifelines
    \draw[lifeline] (user.south) -- ++(0,-8.6);
    \draw[lifeline] (client.south) -- ++(0,-8.6);
    \draw[lifeline] (server.south) -- ++(0,-8.6);
    % Messages
    \draw[arrow] ([yshift=-0.8cm]user.south) -- node[above]{Mở ứng dụng} ([yshift=-0.8cm]client.south);
    \draw[arrow] ([yshift=-1.8cm]client.south) -- node[above]{POST /api/auth/start} ([yshift=-1.8cm]server.south);
    \draw[arrow] ([yshift=-2.6cm]server.south) -- node[above]{Set-Cookie: nonce} ([yshift=-2.6cm]client.south);
    \draw[arrow] ([yshift=-3.6cm]client.south) -- node[above]{Ký thông điệp: ``Sign this nonce: n''} ([yshift=-3.6cm]user.south);
    \draw[arrow] ([yshift=-4.6cm]user.south) -- node[above]{Trả chữ ký (signature)} ([yshift=-4.6cm]client.south);
    \draw[arrow] ([yshift=-5.6cm]client.south) -- node[above]{POST /api/auth/verify (address, signature)} ([yshift=-5.6cm]server.south);
    \draw[arrow] ([yshift=-6.6cm]server.south) -- node[above]{JWT session cookie, clear nonce} ([yshift=-6.6cm]client.south);
    \draw[arrow] ([yshift=-7.6cm]client.south) -- node[above]{Đã đăng nhập} ([yshift=-7.6cm]user.south);
  \end{tikzpicture}
  \caption{Sequence đăng nhập: ký nonce bằng MetaMask}
\end{figure}

\section{Sequence: Upload (mã hoá phía client)}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[x=1cm,y=1cm]
    % Participants
    \node (user) at (0,0) [part,text width=8em]{Người dùng};
    \node (client) at (6,0) [part,text width=11em]{Trình duyệt (Web Crypto)};
    \node (api) at (13,0) [part,text width=11em]{Backend API};
    \node (store) at (19,0) [part,text width=9.5em]{Storage (CID)};
    % Lifelines
    \draw[lifeline] (user.south) -- ++(0,-10.4);
    \draw[lifeline] (client.south) -- ++(0,-10.4);
    \draw[lifeline] (api.south) -- ++(0,-10.4);
    \draw[lifeline] (store.south) -- ++(0,-10.4);
    % Messages
    \draw[arrow] ([yshift=-0.9cm]user.south) -- node[above]{Chọn tệp} ([yshift=-0.9cm]client.south);
    \draw[arrow] ([yshift=-1.9cm]client.south) -- node[above]{GenerateKey + IV; AES‑GCM Encrypt} ([yshift=-1.9cm]client.south -| client.south);
    \draw[arrow] ([yshift=-2.9cm]client.south) -- node[above]{PBKDF2 + Wrap key (tuỳ chọn)} ([yshift=-2.9cm]client.south -| client.south);
    \draw[arrow] ([yshift=-3.9cm]client.south) -- node[above]{GET /api/csrf} ([yshift=-3.9cm]api.south);
    \draw[arrow] ([yshift=-4.7cm]api.south) -- node[above]{Set-Cookie: csrf} ([yshift=-4.7cm]client.south);
    \draw[arrow] ([yshift=-5.7cm]client.south) -- node[above]{POST /api/storage/upload (ciphertext)} ([yshift=-5.7cm]api.south);
    \draw[arrow] ([yshift=-6.5cm]api.south) -- node[above]{PUT ciphertext →} ([yshift=-6.5cm]store.south);
    \draw[arrow] ([yshift=-7.3cm]store.south) -- node[above]{CID} ([yshift=-7.3cm]api.south);
    \draw[arrow] ([yshift=-8.1cm]api.south) -- node[above]{\{ cid \}} ([yshift=-8.1cm]client.south);
    \draw[arrow] ([yshift=-9.1cm]client.south) -- node[above]{POST /api/files (IV, key info, TTL)} ([yshift=-9.1cm]api.south);
    \draw[arrow] ([yshift=-10.0cm]api.south) -- node[above]{\{ token \}} ([yshift=-10.0cm]client.south);
  \end{tikzpicture}
  \caption{Sequence upload: mã hoá client‑side, lưu ciphertext, phát token}
\end{figure}

\section{Sequence: Download (giải mã phía client)}
\begin{figure}[H]
  \centering
  \begin{tikzpicture}[x=1cm,y=1cm]
    % Participants
    \node (user) at (0,0) [part,text width=8em]{Người nhận};
    \node (client) at (6,0) [part,text width=11em]{Trình duyệt (Web Crypto)};
    \node (api) at (13,0) [part,text width=11em]{Backend API};
    \node (store) at (19,0) [part,text width=9.5em]{Storage (CID)};
    % Lifelines
    \draw[lifeline] (user.south) -- ++(0,-10.2);
    \draw[lifeline] (client.south) -- ++(0,-10.2);
    \draw[lifeline] (api.south) -- ++(0,-10.2);
    \draw[lifeline] (store.south) -- ++(0,-10.2);
    % Messages
    \draw[arrow] ([yshift=-0.9cm]user.south) -- node[above]{Nhập token} ([yshift=-0.9cm]client.south);
    \draw[arrow] ([yshift=-1.9cm]client.south) -- node[above]{POST /api/tokens/validate} ([yshift=-1.9cm]api.south);
    \draw[arrow] ([yshift=-2.9cm]api.south) -- node[above]{\{ iv, cid, (salt, ivWrap, wrappedKey)|rawKey \}} ([yshift=-2.9cm]client.south);
    \draw[arrow] ([yshift=-3.9cm]client.south) -- node[above]{GET /api/storage/get?cid=...} ([yshift=-3.9cm]store.south);
    \draw[arrow] ([yshift=-4.9cm]store.south) -- node[above]{ciphertext} ([yshift=-4.9cm]client.south);
    \draw[arrow] ([yshift=-5.9cm]client.south) -- node[above]{Nếu wrapped: PBKDF2 → decrypt wrappedKey} ([yshift=-5.9cm]client.south -| client.south);
    \draw[arrow] ([yshift=-6.9cm]client.south) -- node[above]{AES‑GCM Decrypt(ciphertext, iv, key)} ([yshift=-6.9cm]client.south -| client.south);
    \draw[arrow] ([yshift=-7.9cm]client.south) -- node[above]{Tải file rõ} ([yshift=-7.9cm]user.south);
  \end{tikzpicture}
  \caption{Sequence download: xác thực token, tải ciphertext, giải mã trên client}
\end{figure}
