\chapter{Thuật toán và giải thuật chi tiết}

\section{Mã hoá AES‑256‑GCM phía client}
\begin{algorithm}[H]
\caption{EncryptClient(plain)}
\begin{algorithmic}[1]
  \State $iv \gets$ RandomBytes(12)
  \State $key \gets$ GenerateKey(AES-GCM, 256)
  \State $cipher \gets$ AESGCM.Encrypt($key, iv, plain, AAD=\varnothing$)
  \State $rawKey \gets$ ExportKeyRaw($key$)
  \State \Return $(cipher, iv, rawKey)$
\end{algorithmic}
\end{algorithm}

\section{Bao bọc khoá bằng passphrase}
\begin{algorithm}[H]
\caption{WrapKeyPBKDF2(rawKey, pass)}
\begin{algorithmic}[1]
  \State $salt \gets$ RandomBytes(16)
  \State $base \gets$ PBKDF2(pass, salt, iter=200000, hash=SHA-256)
  \State $iv_w \gets$ RandomBytes(12)
  \State $wrapped \gets$ AESGCM.Encrypt($base, iv_w, rawKey$)
  \State \Return $(salt, iv_w, wrapped)$
\end{algorithmic}
\end{algorithm}

\section{Xác thực bằng chữ ký ví Ethereum}
\begin{algorithm}[H]
\caption{LoginMetaMask()}
\begin{algorithmic}[1]
  \State Server phát nonce, set cookie \texttt{nonce}
  \State Client ký thông điệp \texttt{``Sign this nonce to login: <nonce>''}
  \State Server \texttt{verifyMessage} → địa chỉ ví; so khớp với yêu cầu
  \State Nếu hợp lệ: phát JWT phiên (cookie \texttt{session})
\end{algorithmic}
\end{algorithm}

\section{Cấp và xác thực token}
\begin{algorithm}[H]
\caption{IssueAndValidateToken}
\begin{algorithmic}[1]
  \State Issue: tạo UUID, \texttt{expiresAt}, lưu kèm \texttt{fileId}
  \State Validate: kiểm tra thu hồi/hết hạn; trả về metadata (IV, CID, key info)
\end{algorithmic}
\end{algorithm}

